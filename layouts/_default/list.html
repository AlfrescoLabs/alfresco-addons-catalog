{{ define "main" }}

{{ partial "hero.html" . }}
<div id="catalog-hero-toggle" class="catalog-hero-toggle" aria-expanded="true">
  <a href="#">About this Catalog</a>
</div>

<div class="layout">
  <aside class="sidebar" role="complementary" aria-label="Filters">
    <div id="facet-root">
      <div class="facet-block">
        <h4 id="facet-license-label">License</h4>
        <div id="facet-license" role="group" aria-labelledby="facet-license-label"></div>
      </div>
      <div class="facet-block">
        <h4 id="facet-compat-label">Compatibility</h4>
        <div id="facet-compat" role="group" aria-labelledby="facet-compat-label"></div>
      </div>
      <div class="facet-block">
        <h4 id="facet-keywords-label">Keywords</h4>
        <div id="facet-keywords" role="group" aria-labelledby="facet-keywords-label"></div>
      </div>
      <div class="facet-block">
        <h4 id="facet-type-label">Type</h4>
        <div id="facet-type" role="group" aria-labelledby="facet-type-label"></div>
      </div>
      <button id="facet-clear" class="btn-clear" type="button">Clear filters</button>
    </div>
  </aside>

  <section class="results">
    <div class="searchbar">
      <div class="input">
        <input id="q" type="search" placeholder="Search solutions, vendors, keywords..." aria-label="Search"/>
      </div>
      <div class="facet">
        <span>Sort</span>
        <select id="sort">
          <option value="relevance">Relevance</option>
          <option value="az">A to Z</option>
          <option value="za">Z to A</option>
          <option value="newest" selected>Newest</option>
        </select>
      </div>
    </div>

    <!-- Server-rendered (paginated) grid for no-JS & initial load -->
    <section class="grid" id="cards">
      {{ $all := where .Site.RegularPages "Section" "entries" }}
      {{ $p := .Paginate $all }}
      {{ range $p.Pages }}
        {{ partial "card.html" . }}
      {{ end }}
    </section>

    <!-- Server-side pagination (SEO & no-JS). Will be replaced in client mode -->
    <nav class="pagination" id="server-pagination">
      {{ template "_internal/pagination.html" . }}
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <script>
// Persist hero toggle state
const heroToggle = document.getElementById('catalog-hero-toggle');
try {
  const k = 'catalog-hero-collapsed';
  const collapsed = localStorage.getItem(k) === '1';
  heroToggle.setAttribute('aria-expanded', (!collapsed).toString());
  heroToggle.addEventListener('click', (e) => {
    e.preventDefault();
    const expanded = heroToggle.getAttribute('aria-expanded') === 'true';
    heroToggle.setAttribute('aria-expanded', (!expanded).toString());
    localStorage.setItem(k, expanded ? '1' : '0');
  });
} catch(_) {}

    (function () {
      // Reuse server page size for client pagination
      const PAGE_SIZE = {{ $p.PageSize }};
      const KEYWORDS_LIMIT = {{ with .Site.Params.facets.keywordsLimit }}{{ . }}{{ else }}10{{ end }};

      // DOM refs
      const grid   = document.getElementById('cards');
      const pager  = document.getElementById('server-pagination');
      const q      = document.getElementById('q');
      const sort   = document.getElementById('sort');
      const fx = {
        license:  document.getElementById('facet-license'),
        compat:   document.getElementById('facet-compat'),
        keywords: document.getElementById('facet-keywords'),
    type:     document.getElementById('facet-type'),
        clearBtn: document.getElementById('facet-clear'),
      };

      // Load index once on page load to build facets (does NOT switch to client rendering)
      document.addEventListener('DOMContentLoaded', () => { ensureIndex(); });

      // State
      let data = null, fuse = null, indexLoaded = false;
      let currentPage = 1;
      let lastClientList = [];

      async function ensureIndex() {
        if (indexLoaded) return;
        const res = await fetch('{{ "index.json" | relURL }}');
        data = await res.json();
        fuse = new Fuse(data, {
          keys: ['title','vendor','keywords','description','compatibility','license'],
          threshold: 0.3
        });
        buildFacets();
        indexLoaded = true;
      }

      // Utils
      const uniq = (arr) => [...new Set(arr)].filter(Boolean).sort();
      const flat = (arr) => arr.flat ? arr.flat() : [].concat.apply([], arr);

      function buildFacets(){
        const values = {
          license:  uniq(data.map(x => x.license)),
          compat:   uniq(flat(data.map(x => x.compatibility || []))),
          // keywords are handled via counts to pick top-N
        };

        function countsFor(list, key, arrayField) {
          const m = {};
          list.forEach(x => {
            const val = x[key];
            if (arrayField) (val || []).forEach(v => { m[v] = (m[v] || 0) + 1; });
            else if (val)   m[val] = (m[val] || 0) + 1;
          });
          return m;
        }

        function renderFacet(root, items, counts) {
          root.innerHTML = '';
          const ordered = [...items].sort((a,b) => (counts[b]||0)-(counts[a]||0) || a.localeCompare(b));
          ordered.forEach(v => {
            const id  = encodeURIComponent(v);
            const cnt = counts[v] || 0;
            const lab = document.createElement('label');
            lab.className = 'chk';
            lab.innerHTML = `
              <input type="checkbox" value="${id}">
              <span>${v}</span>
              <em>${cnt}</em>
            `;
            root.appendChild(lab);
          });
          root.addEventListener('change', onUserIntent(() => { currentPage = 1; applyClient(); }));
        }

        // Build facets
        renderFacet(fx.license, values.license, countsFor(data,'license',false));
        renderFacet(fx.compat,  values.compat,  countsFor(data,'compatibility',true));

        // --- TOP-N KEYWORDS ---
        const kwCounts = countsFor(data,'keywords',true);
        const topKeywords = Object.entries(kwCounts)
          .sort((a,b) => b[1] - a[1] || a[0].localeCompare(b[0]))
          .slice(0, Math.max(0, KEYWORDS_LIMIT))
          .map(([k]) => k);
        renderFacet(fx.keywords, topKeywords, kwCounts);
      }

      function getFilters(){
        const pick = (root) => [...root.querySelectorAll('input[type="checkbox"]:checked')].map(x => decodeURIComponent(x.value));
        return {
          text:     q.value.trim(),
          license:  pick(fx.license),
          compat:   pick(fx.compat),
          keywords: pick(fx.keywords),
          sort:     sort.value || 'newest',
        };
      }

      function renderCard(item) {
        const a = document.createElement('article');
        a.className = 'card';
        a.setAttribute('data-slug', item.slug);
        const compat  = (item.compatibility && item.compatibility.length) ? `Compat: ${item.compatibility.join(', ')}` : '';
        const license = item.license ? `License: ${item.license}` : '';
        const link = '{{ "entries/" | relURL }}' + item.slug + '/';
        const dl   = item.download_url ? `<a href="${item.download_url}" target="_blank" rel="noopener">Download</a>` : '';
        a.innerHTML = `
          <h3><a href="${link}">${item.title}</a></h3>
          <p class="vendor">by ${item.vendor || ''}</p>
          <p class="desc">${item.description || ''}</p>
          <div class="badges">
            ${compat ? `<span class="badge">${compat}</span>` : ''}
            ${license ? `<span class="badge badge--muted">${license}</span>` : ''}
          </div>
          <div class="links">${dl}</div>
        `;
        return a;
      }

      // ---------- Client-side pagination ----------
      function renderClient(list){
        lastClientList = list;
        const total = list.length;
        const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
        if (currentPage > pages) currentPage = 1;

        const start = (currentPage - 1) * PAGE_SIZE;
        const pageItems = list.slice(start, start + PAGE_SIZE);

        // cards
        grid.innerHTML = '';
        pageItems.forEach(item => grid.appendChild(renderCard(item)));

        // pager (replace server pager with client pager)
        if (!pager) return;
        pager.style.display = '';
        pager.innerHTML = buildPagerHTML(pages, currentPage);

        // bind clicks
        pager.querySelectorAll('[data-page]').forEach(el => {
          el.addEventListener('click', (e) => {
            e.preventDefault();
            const p = parseInt(el.getAttribute('data-page'), 10);
            if (!isNaN(p)) { currentPage = p; renderClient(lastClientList); }
          });
        });
      }

      function buildPagerHTML(pages, page){
        const btn = (p, label, disabled=false, active=false) => {
          if (disabled) return `<li class="disabled"><span>${label}</span></li>`;
          if (active)   return `<li class="active"><a href="#" aria-current="page">${label}</a></li>`;
          return `<li><a href="#" data-page="${p}">${label}</a></li>`;
        };
        const prev  = btn(page-1, '«', page<=1);
        const first = btn(1, '««', page<=1);
        const next  = btn(page+1, '»', page>=pages);
        const last  = btn(pages, '»»', page>=pages);

        let nums = '';
        for (let i=1;i<=pages;i++) nums += btn(i, String(i), false, i===page);

        return `<ul>${first}${prev}${nums}${next}${last}</ul>`;
      }
      // -------------------------------------------

      function applyClient(){
        const f = getFilters();
        let list = data.slice();

        // Search
        let scoreMap = null;
        if (f.text) {
          const results = fuse.search(f.text);
          scoreMap = new Map(results.map(r => [r.item.slug, r.score]));
          list = results.map(r => r.item);
        }

        // Facets
        if (f.license.length)  list = list.filter(x => x.license && f.license.includes(x.license));
        if (f.compat.length)   list = list.filter(x => (x.compatibility || []).some(v => f.compat.includes(v)));
        if (f.keywords.length) list = list.filter(x => (x.keywords || []).some(v => f.keywords.includes(v)));

        // Sort
        if (f.sort === 'az') list.sort((a,b) => a.title.localeCompare(b.title));
        else if (f.sort === 'za') list.sort((a,b) => b.title.localeCompare(a.title));
        else if (f.sort === 'newest') list.sort((a,b) => (b.date||0) - (a.date||0));
        else if (f.sort === 'relevance' && scoreMap) list.sort((a,b) => (scoreMap.get(a.slug)||0) - (scoreMap.get(b.slug)||0));

        // Render current page + pager
        renderClient(list);
      }

      // Wire up interactions: lazy-load index, then apply
      function onUserIntent(handler){
        return async function(...args){
          await ensureIndex();
          handler.apply(this, args);
        }
      }

      q.addEventListener('input', onUserIntent(() => { currentPage = 1; applyClient(); }));
      q.addEventListener('keyup', onUserIntent(e => { if (e.key === 'Enter') { currentPage = 1; applyClient(); } }));
      sort.addEventListener('change', onUserIntent(() => { currentPage = 1; applyClient(); }));
      fx.clearBtn.addEventListener('click', function(){
        // Hard reset to restore server pagination perfectly
        window.location.href = window.location.pathname;
      });
    })();
    </script>
  </section>
</div>

{{ end }}
